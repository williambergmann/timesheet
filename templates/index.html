{% extends "base.html" %}

{% block title %}Time Timesheet - Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
{% endblock %}

{% block content %}
<div id="app" class="app-container">
    <!-- Sidebar Navigation -->
    <aside class="sidebar">
        <nav class="sidebar-nav">
            <a href="#timesheets" class="sidebar-link active" data-view="timesheets">
                <span class="icon">üìã</span>
                My Timesheets
            </a>
            <a href="#new" class="sidebar-link" data-view="new">
                <span class="icon">‚ûï</span>
                New Timesheet
            </a>
            {% if user.is_admin %}
            <hr class="sidebar-divider">
            <a href="#admin" class="sidebar-link" data-view="admin">
                <span class="icon">‚öôÔ∏è</span>
                Admin Dashboard
            </a>
            {% endif %}
        </nav>
    </aside>

    <!-- Main Content Area -->
    <div class="content-area">
        <!-- Timesheets List View -->
        <section id="view-timesheets" class="view active">
            <div class="view-header">
                <h2>My Timesheets</h2>
                <button class="btn btn-primary" onclick="showNewTimesheetView()">
                    + New Timesheet
                </button>
            </div>
            <div class="filters">
                <select id="filter-status" class="form-select">
                    <option value="">All Statuses</option>
                    <option value="NEW">Draft</option>
                    <option value="SUBMITTED">Submitted</option>
                    <option value="APPROVED">Approved</option>
                    <option value="NEEDS_APPROVAL">Needs Approval</option>
                </select>
            </div>
            <div id="timesheets-list" class="timesheets-grid">
                <!-- Populated by JavaScript -->
                <div class="loading">Loading timesheets...</div>
            </div>
        </section>

        <!-- New/Edit Timesheet View -->
        <section id="view-editor" class="view">
            <div class="view-header">
                <button class="btn btn-back" onclick="showTimesheetsView()">‚Üê Back</button>
                <h2 id="editor-title">New Timesheet</h2>
            </div>
            <form id="timesheet-form" class="timesheet-form">
                <input type="hidden" id="timesheet-id">
                
                <div class="form-group">
                    <label for="week-start">Week Starting (Sunday)</label>
                    <input type="date" id="week-start" class="form-input" required>
                </div>

                <div class="form-section">
                    <h3>Time Entries</h3>
                    <div id="entries-grid" class="entries-grid">
                        <!-- Day columns generated by JS -->
                    </div>
                </div>

                <div class="form-section">
                    <h3>Additional Info</h3>
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="traveled">
                            <span>Traveled this week</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="has-expenses">
                            <span>Has Expenses</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="reimbursement-needed">
                            <span>Reimbursement Needed</span>
                        </label>
                    </div>
                </div>

                <div id="reimbursement-section" class="form-section hidden">
                    <h3>Reimbursement Details</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="reimbursement-type">Type</label>
                            <select id="reimbursement-type" class="form-select">
                                <option value="Car">Car</option>
                                <option value="Flight">Flight</option>
                                <option value="Food">Food</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="reimbursement-amount">Amount ($)</label>
                            <input type="number" id="reimbursement-amount" class="form-input" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label for="stipend-date">Stipend Date</label>
                            <input type="date" id="stipend-date" class="form-input">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Attachments</h3>
                    <div id="attachments-list" class="attachments-list"></div>
                    <div class="upload-zone" id="upload-zone">
                        <input type="file" id="file-upload" accept=".pdf,.png,.jpg,.jpeg,.gif" hidden>
                        <p>Drag & drop files here or <button type="button" class="btn-link" onclick="document.getElementById('file-upload').click()">browse</button></p>
                        <small>Accepted: PDF, PNG, JPG, GIF (max 16MB)</small>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Notes</h3>
                    <textarea id="notes" class="form-textarea" rows="3" placeholder="Add any notes or comments..."></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="saveDraft()">Save Draft</button>
                    <button type="button" class="btn btn-primary" onclick="submitTimesheet()">Submit</button>
                    <button type="button" class="btn btn-danger" id="delete-btn" onclick="deleteTimesheet()">Delete</button>
                </div>
            </form>
        </section>

        <!-- Admin View -->
        {% if user.is_admin %}
        <section id="view-admin" class="view">
            <div class="view-header">
                <h2>Admin Dashboard</h2>
            </div>
            <div class="filters">
                <select id="admin-filter-status" class="form-select">
                    <option value="">All Statuses</option>
                    <option value="SUBMITTED">Submitted</option>
                    <option value="APPROVED">Approved</option>
                    <option value="NEEDS_APPROVAL">Needs Approval</option>
                </select>
                <select id="admin-filter-user" class="form-select">
                    <option value="">All Users</option>
                    <!-- Populated by JS -->
                </select>
            </div>
            <div id="admin-timesheets-list" class="timesheets-grid">
                <div class="loading">Loading timesheets...</div>
            </div>
        </section>
        {% endif %}
    </div>
</div>

<!-- Toast Notifications -->
<div id="toast-container" class="toast-container"></div>
{% endblock %}

{% block extra_js %}
<script>
    // Pass user data to JavaScript
    window.currentUser = {{ user | tojson | safe }};
</script>
<script src="{{ url_for('static', filename='js/api.js') }}"></script>
<script src="{{ url_for('static', filename='js/timesheet.js') }}"></script>
<script src="{{ url_for('static', filename='js/app.js') }}"></script>
{% if user.is_admin %}
<script src="{{ url_for('static', filename='js/admin.js') }}"></script>
{% endif %}
<script src="{{ url_for('static', filename='js/sse.js') }}"></script>
{% endblock %}
