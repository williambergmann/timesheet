{% extends "base.html" %}

{% block title %}Northstar Time Timesheet - Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}?v=20260106p7" />
{% endblock %}

{% block content %}
<div class="app-container">
  <!-- Sidebar Navigation -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <p class="sidebar-title">Navigation</p>
    </div>
    
    <nav class="sidebar-nav">
      <a href="#timesheets" class="sidebar-link active" data-view="timesheets">
        <span class="icon">üìã</span>
        My Timesheets
      </a>
      <a href="#new" class="sidebar-link" data-view="editor">
        <span class="icon">‚ú®</span>
        New Timesheet
      </a>
      {% if user.is_admin %}
      <hr class="sidebar-divider" />
      <a href="#admin" class="sidebar-link" data-view="admin">
        <span class="icon">üë•</span>
        Admin Dashboard
      </a>
      {% endif %}
    </nav>
  </aside>

  <!-- Main Content Area -->
  <main class="content-area">
    
    <!-- Timesheets List View -->
    <section id="view-timesheets" class="view active">
      <div class="view-header">
        <h2>My Timesheets</h2>
        <div class="view-header-actions">
          <button class="btn btn-ghost" id="refresh-timesheets-btn" title="Refresh timesheets">
            <span>üîÑ</span>
            Refresh
          </button>
          <button class="btn btn-primary" id="create-timesheet-btn">
            <span>‚ú®</span>
            New Timesheet
          </button>
        </div>
      </div>
      
      <div class="filters">
        <div class="filter-group">
          <label class="filter-label">Status:</label>
          <select id="filter-status" class="form-select">
            <option value="">All Statuses</option>
            <option value="NEW">Draft</option>
            <option value="SUBMITTED">Submitted</option>
            <option value="NEEDS_APPROVAL">Needs Approval</option>
            <option value="APPROVED">Approved</option>
          </select>
          <button type="button" class="help-icon" id="status-help-btn" title="Status Definitions">
            ?
          </button>
          <!-- Status Definitions Help Popup -->
          <div id="status-help-popup" class="help-popup hidden">
            <div class="help-popup-header">
              <h4>Status Definitions</h4>
              <button type="button" class="help-popup-close" id="status-help-close">&times;</button>
            </div>
            <div class="help-popup-content">
              <dl class="help-definitions">
                <dt>Draft</dt>
                <dd>Timesheet is being worked on but not yet submitted for approval.</dd>
                <dt>Submitted</dt>
                <dd>Timesheet has been sent to admin for review and approval.</dd>
                <dt>Needs Approval</dt>
                <dd>Timesheet requires additional action (e.g., missing attachments for field hours).</dd>
                <dt>Approved</dt>
                <dd>Timesheet has been reviewed and approved by an administrator.</dd>
              </dl>
            </div>
          </div>
        </div>
      </div>
      
      <div id="timesheets-list" class="timesheets-grid">
        <div class="loading">Loading timesheets...</div>
      </div>
    </section>

    <!-- Timesheet Editor View -->
    <section id="view-editor" class="view">
      <div class="view-header">
        <h2 id="editor-title">New Timesheet</h2>
        <span id="unsaved-changes-warning" class="unsaved-changes-warning hidden">
          ‚óè Unsaved changes
        </span>
        <button class="btn btn-ghost" id="back-to-list-btn">
          ‚Üê Back to List
        </button>
      </div>
      
      <form id="timesheet-form" class="timesheet-form">
        <input type="hidden" id="timesheet-id" />
        
        <!-- Week Selection -->
        <div class="form-section">
          <div class="form-section-header">
            <div class="form-section-icon">üìÖ</div>
            <h3>Week Selection</h3>
          </div>
          <div class="form-group">
            <label for="week-start">Week Starting (Sunday)</label>
            <input type="date" id="week-start" name="week_start" class="form-input" required />
          </div>
          <div class="checkbox-group" id="auto-populate-group">
            <div class="checkbox-item">
              <input type="checkbox" id="auto-populate" name="auto_populate" />
              <label for="auto-populate">Auto-fill 40h Field Hours (8h Mon-Fri)</label>
            </div>
          </div>
        </div>

        <!-- Time Entries -->
        <div class="form-section">
          <div class="form-section-header">
            <div class="form-section-icon">‚è±Ô∏è</div>
            <h3>Time Entries</h3>
            <button type="button" class="help-icon" id="time-code-help-btn" title="Time Code Definitions">
              ?
            </button>
            <!-- Time Code Help Popup (inside header for proper positioning) -->
            <div id="time-code-help-popup" class="help-popup hidden">
              <div class="help-popup-header">
                <h4>Time Code Definitions</h4>
                <button type="button" class="help-popup-close" id="time-code-help-close">&times;</button>
              </div>
              <div class="help-popup-content">
                <dl class="help-definitions">
                  <dt>Field Hours</dt>
                  <dd>Hours worked for client - billable time on-site or remote for customer projects.</dd>
                  <dt>Internal Hours</dt>
                  <dd>Hours worked for NST (Northstar internal) - non-billable company work.</dd>
                  <dt>Training</dt>
                  <dd>Hours spent in training - tracking purposes, not billable.</dd>
                  <dt>PTO</dt>
                  <dd>Paid Time-Off approved by NST - vacation, personal days.</dd>
                  <dt>Unpaid Leave</dt>
                  <dd>Unpaid time off, or hours not worked - no pay or billing.</dd>
                  <dt>Holiday</dt>
                  <dd>Holidays paid by NST - company-observed holidays.</dd>
                </dl>
              </div>
            </div>
          </div>
          
          <!-- Add Hour Type Row -->
          <div class="add-hour-type-row">
            <select id="hour-type-selector" class="form-select">
              <option value="">Select hour type to add...</option>
              <option value="Field">Field Hours</option>
              <option value="Internal">Internal Hours</option>
              <option value="Training">Training</option>
              <option value="PTO">PTO</option>
              <option value="Unpaid">Unpaid Leave</option>
              <option value="Holiday">Holiday</option>
            </select>
            <button type="button" id="add-hour-type-btn" class="btn btn-icon" title="Add hour type">
              +
            </button>
          </div>

          <!-- Hour Type Rows Table -->
          <div id="hour-type-table" class="hour-type-table">
            <!-- Table Header -->
            <div class="hour-type-header">
              <div class="hour-type-label-cell">Hour Type</div>
              <div class="hour-type-day-cell">Sun</div>
              <div class="hour-type-day-cell">Mon</div>
              <div class="hour-type-day-cell">Tue</div>
              <div class="hour-type-day-cell">Wed</div>
              <div class="hour-type-day-cell">Thu</div>
              <div class="hour-type-day-cell">Fri</div>
              <div class="hour-type-day-cell">Sat</div>
              <div class="hour-type-total-cell">Total</div>
              <div class="hour-type-actions-cell">Actions</div>
            </div>
            <!-- Dynamic rows will be inserted here by JavaScript -->
            <div id="hour-type-rows"></div>
          </div>
        </div>

        <!-- Additional Info -->
        <div class="form-section">
          <div class="form-section-header">
            <div class="form-section-icon">üìù</div>
            <h3>Additional Information</h3>
          </div>
          <div class="checkbox-group">
            <div class="checkbox-item">
              <input type="checkbox" id="traveled" name="traveled" />
              <label for="traveled">Traveled this week</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="has-expenses" name="has_expenses" />
              <label for="has-expenses">Has expenses</label>
            </div>
            <div class="checkbox-item">
              <input
                type="checkbox"
                id="reimbursement-needed"
                name="reimbursement_needed"
              />
              <label for="reimbursement-needed">Reimbursement needed</label>
            </div>
          </div>
        </div>

        <!-- Reimbursement Details (shown when reimbursement-needed checked) -->
        <div id="reimbursement-section" class="form-section hidden">
          <div class="form-section-header">
            <div class="form-section-icon">üí∞</div>
            <h3>Reimbursement Details</h3>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="reimbursement-type">Type</label>
              <select id="reimbursement-type" name="reimbursement_type" class="form-select">
                <option value="">Select type...</option>
                <option value="Car">Car</option>
                <option value="Flight">Flight</option>
                <option value="Food">Food</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="form-group">
              <label for="reimbursement-amount">Amount ($)</label>
              <input type="number" id="reimbursement-amount" name="reimbursement_amount" class="form-input" step="0.01" min="0" placeholder="0.00" />
            </div>
            <div class="form-group">
              <label for="stipend-date">Stipend Date</label>
              <input type="date" id="stipend-date" name="stipend_date" class="form-input" />
            </div>
          </div>
        </div>

        <!-- Attachments -->
        <div class="form-section">
          <div class="form-section-header">
            <div class="form-section-icon">üìé</div>
            <h3>Attachments</h3>
            <button type="button" class="help-icon" id="attachment-help-btn" title="Attachment Requirements">
              ?
            </button>
            <!-- Attachment Info Popup -->
            <div id="attachment-help-popup" class="help-popup hidden">
              <div class="help-popup-header">
                <h4>Attachment Requirements</h4>
                <button type="button" class="help-popup-close" id="attachment-help-close">&times;</button>
              </div>
              <div class="help-popup-content">
                <dl class="help-definitions">
                  <dt>Field Hours</dt>
                  <dd>Field engineers must upload at least one image as proof of work.</dd>
                  <dt>Accepted Formats</dt>
                  <dd>PDF, PNG, JPG, JPEG, GIF files are supported.</dd>
                  <dt>File Size Limit</dt>
                  <dd>Maximum 16MB per file.</dd>
                  <dt>Multiple Files</dt>
                  <dd>You can attach multiple files by dragging or selecting them.</dd>
                </dl>
              </div>
            </div>
          </div>
          <!-- Field Hours Warning -->
          <div id="field-hours-warning" class="field-hours-warning hidden">
            ‚ö†Ô∏è Field engineers must submit at least one image.
          </div>
          <div class="attachments-section">
            <div id="attachments-list" class="attachments-list">
              <p id="empty-attachments-text" class="empty-attachments-text">There is nothing attached.</p>
            </div>
            <div id="upload-zone" class="upload-zone">
              <div class="upload-zone-icon">üìÅ</div>
              <p>Drag & drop files here or <strong>browse</strong></p>
              <small>PDF, PNG, JPG, GIF up to 16MB</small>
              <input type="file" id="file-upload" accept=".pdf,.png,.jpg,.jpeg,.gif" multiple hidden />
            </div>
          </div>
        </div>

        <!-- User Notes -->
        <div class="form-section">
          <div class="form-section-header">
            <div class="form-section-icon">üí¨</div>
            <h3>Notes</h3>
          </div>
          <div class="form-group">
            <label for="user-notes">Your Notes <span class="char-counter" id="user-notes-counter">0/255</span></label>
            <textarea id="user-notes" name="user_notes" class="form-textarea" rows="3" maxlength="255" placeholder="Enter any comments (255 characters max)..."></textarea>
          </div>
        </div>

        <!-- Admin Notes (read-only for users) -->
        <div id="admin-notes-section" class="form-section">
          <div class="form-section-header">
            <div class="form-section-icon">üë§</div>
            <h3>Admin Notes</h3>
          </div>
          <div class="form-group">
            <div id="admin-notes-display" class="admin-notes-display"></div>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button type="button" id="delete-btn" class="btn btn-danger hidden">
            üóëÔ∏è Delete
          </button>
          <button type="button" id="save-draft-btn" class="btn btn-secondary">
            üíæ Save Draft
          </button>
          <button type="button" id="submit-btn" class="btn btn-primary">
            üöÄ Submit
          </button>
        </div>
      </form>
    </section>

    <!-- Admin Dashboard View -->
    {% if user.is_admin %}
    <section id="view-admin" class="view">
      <div class="view-header">
        <h2>Admin Dashboard</h2>
      </div>
      
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon primary">üìä</div>
          <div class="stat-content">
            <h4 id="stat-pending">-</h4>
            <p>Pending Review</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon accent">‚úÖ</div>
          <div class="stat-content">
            <h4 id="stat-approved">-</h4>
            <p>Approved This Week</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon warning">‚ö†Ô∏è</div>
          <div class="stat-content">
            <h4 id="stat-needs-attention">-</h4>
            <p>Needs Attention</p>
          </div>
        </div>
      </div>
      
      <div class="admin-section">
        <div class="filters">
          <div class="filter-group">
            <label class="filter-label">Status:</label>
            <select id="admin-filter-status" class="form-select">
              <option value="">All Statuses</option>
              <option value="SUBMITTED" selected>Submitted</option>
              <option value="NEEDS_APPROVAL">Needs Approval</option>
              <option value="APPROVED">Approved</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">User:</label>
            <select id="admin-filter-user" class="form-select">
              <option value="">All Users</option>
            </select>
          </div>
        </div>
        
        <div id="admin-timesheets-list" class="timesheets-grid">
          <div class="loading">Loading timesheets...</div>
        </div>
      </div>
      
      <div id="admin-detail" class="timesheet-detail hidden">
        <!-- Populated by JavaScript -->
      </div>
    </section>
    {% endif %}
    
  </main>
</div>

<!-- Toast Container -->
<div id="toast-container" class="toast-container"></div>
{% endblock %}

{% block extra_js %}
<script>
  window.currentUser = {{ user|tojson }};
</script>
<script src="{{ url_for('static', filename='js/api.js') }}?v=20260106p1"></script>
<script src="{{ url_for('static', filename='js/timesheet.js') }}?v=20260106p6"></script>
<script src="{{ url_for('static', filename='js/admin.js') }}?v=20260106p1"></script>
<script src="{{ url_for('static', filename='js/sse.js') }}?v=20260106p1"></script>
<script src="{{ url_for('static', filename='js/app.js') }}?v=20260106p1"></script>
{% endblock %}
