{% extends "base.html" %} {% block title %}Northstar Timesheet App - Dashboard{%
endblock %} {% block extra_css %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/components.css') }}?v=20260111p1"
/>
{% endblock %} {% block content %}
<div class="app-container">
  <!-- Sidebar Navigation -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <p class="sidebar-title">Navigation</p>
    </div>

    <nav class="sidebar-nav">
      <a href="#timesheets" class="sidebar-link active" data-view="timesheets">
        <span class="icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg></span>
        My Timesheets
      </a>
      <a href="#new" class="sidebar-link" data-view="editor">
        <span class="icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg></span>
        New Timesheet
      </a>
      {% if user.is_admin or user.role == 'support' %}
      <hr class="sidebar-divider" />
      <a href="#admin" class="sidebar-link" data-view="admin">
        <span class="icon">üë•</span>
        {% if user.role == 'support' %}Trainee Approvals{% else %}Admin Dashboard{% endif %}
      </a>
      {% if user.is_admin %}
      <a href="#report" class="sidebar-link" data-view="report">
        <span class="icon">üìë</span>
        Data Report
      </a>
      {% endif %}
      {% endif %}
    </nav>
  </aside>

  <!-- Main Content Area -->
  <main class="content-area">
    <!-- Timesheets List View -->
    <section id="view-timesheets" class="view active">
      <div class="view-header">
        <h2>My Timesheets</h2>
        <div class="view-header-actions">
          <button
            class="btn btn-ghost"
            id="refresh-timesheets-btn"
            title="Refresh timesheets"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
            Refresh
          </button>
          <button class="btn btn-primary" id="create-timesheet-btn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            New Timesheet
          </button>
        </div>
      </div>

      <div class="filters">
        <div class="filter-group">
          <label class="filter-label">Status:</label>
          <select id="filter-status" class="form-select">
            <option value="">All Statuses</option>
            <option value="NEW">Draft</option>
            <option value="SUBMITTED">Submitted</option>
            <option value="NEEDS_APPROVAL">Needs Approval</option>
            <option value="APPROVED">Approved</option>
          </select>
          <button
            type="button"
            class="help-icon"
            id="status-help-btn"
            title="Status Definitions"
          >
            ?
          </button>
          <!-- Status Definitions Help Popup -->
          <div id="status-help-popup" class="help-popup hidden">
            <div class="help-popup-header">
              <h4>Status Definitions</h4>
              <button
                type="button"
                class="help-popup-close"
                id="status-help-close"
              >
                &times;
              </button>
            </div>
            <div class="help-popup-content">
              <dl class="help-definitions">
                <dt>Draft</dt>
                <dd>
                  Timesheet is being worked on but not yet submitted for
                  approval.
                </dd>
                <dt>Submitted</dt>
                <dd>
                  Timesheet has been sent to admin for review and approval.
                </dd>
                <dt>Needs Approval</dt>
                <dd>
                  Timesheet requires additional action (e.g., missing
                  attachments for field hours).
                </dd>
                <dt>Approved</dt>
                <dd>
                  Timesheet has been reviewed and approved by an administrator.
                </dd>
              </dl>
            </div>
          </div>
        </div>

        <!-- Sort dropdown -->
        <div class="filter-group">
          <label class="filter-label">Sort:</label>
          <select id="sort-timesheets" class="form-select">
            <option value="newest">Newest ‚Üì</option>
            <option value="oldest">Oldest ‚Üë</option>
            <option value="submitted-newest">Submitted ‚Üì</option>
            <option value="submitted-oldest">Submitted ‚Üë</option>
            <option value="created-newest">Created ‚Üì</option>
            <option value="created-oldest">Created ‚Üë</option>
          </select>
        </div>
      </div>

      <div id="timesheets-list" class="timesheets-grid">
        <div class="loading">Loading timesheets...</div>
      </div>
    </section>

    <!-- Timesheet Editor View -->
    <section id="view-editor" class="view">
      <div class="view-header">
        <h2 id="editor-title">New Timesheet</h2>
        <span
          id="unsaved-changes-warning"
          class="unsaved-changes-warning hidden"
        >
          ‚óè Unsaved changes
        </span>
        <button class="btn btn-ghost" id="back-to-list-btn">
          ‚Üê Back to List
        </button>
      </div>

      <form id="timesheet-form" class="timesheet-form">
        <input type="hidden" id="timesheet-id" />

        <!-- REQ-023: Read-only notice for non-editable timesheets -->
        <div id="readonly-notice" class="readonly-notice hidden">
          This timesheet has been submitted and cannot be edited.
        </div>

        <!-- Week Selection -->
        <div class="form-section">
          <div class="form-section-header">
            <div class="form-section-icon">üìÖ</div>
            <h3>Week Selection</h3>
          </div>
          <div class="form-group">
            <label for="week-start">Week Starting (Sunday)</label>
            <input
              type="date"
              id="week-start"
              name="week_start"
              class="form-input"
              required
            />
          </div>
          <div class="checkbox-group" id="auto-populate-group">
            <div class="checkbox-item">
              <input type="checkbox" id="auto-populate" name="auto_populate" />
              <label for="auto-populate"
                >Auto-fill 40h when adding rows</label
              >
            </div>
          </div>
        </div>

        <!-- Time Entries -->
        <div class="form-section">
          <div class="form-section-header">
            <div class="form-section-icon">‚è±Ô∏è</div>
            <h3>Time Entries</h3>
            <button
              type="button"
              class="help-icon"
              id="time-code-help-btn"
              title="Time Code Definitions"
            >
              ?
            </button>
            <!-- Time Code Help Popup (inside header for proper positioning) -->
            <div id="time-code-help-popup" class="help-popup hidden">
              <div class="help-popup-header">
                <h4>Time Code Definitions</h4>
                <button
                  type="button"
                  class="help-popup-close"
                  id="time-code-help-close"
                >
                  &times;
                </button>
              </div>
              <div class="help-popup-content">
                <dl class="help-definitions">
                  <dt>Field Hours</dt>
                  <dd>
                    Hours worked for client - billable time on-site or remote
                    for customer projects.
                  </dd>
                  <dt>Internal Hours</dt>
                  <dd>
                    Hours worked for NST (Northstar internal) - non-billable
                    company work.
                  </dd>
                  <dt>Training</dt>
                  <dd>
                    Hours spent in training - tracking purposes, not billable.
                  </dd>
                  <dt>PTO</dt>
                  <dd>
                    Paid Time-Off approved by NST - vacation, personal days.
                  </dd>
                  <dt>Unpaid Leave</dt>
                  <dd>
                    Unpaid time off, or hours not worked - no pay or billing.
                  </dd>
                  <dt>Holiday</dt>
                  <dd>Holidays paid by NST - company-observed holidays.</dd>
                </dl>
              </div>
            </div>
          </div>

          <!-- Add Hour Type Row -->
          <div class="add-hour-type-row">
            <select id="hour-type-selector" class="form-select">
              <option value="">Select hour type to add...</option>
              <!-- Options populated by JavaScript based on user role -->
            </select>
            <button
              type="button"
              id="add-hour-type-btn"
              class="btn btn-icon"
              title="Add hour type"
            >
              +
            </button>
          </div>

          <!-- Hour Type Rows Table -->
          <div id="hour-type-table" class="hour-type-table">
            <!-- Table Header -->
            <div class="hour-type-header">
              <div class="hour-type-label-cell">Hour Type</div>
              <div class="hour-type-day-cell">Sun</div>
              <div class="hour-type-day-cell">Mon</div>
              <div class="hour-type-day-cell">Tue</div>
              <div class="hour-type-day-cell">Wed</div>
              <div class="hour-type-day-cell">Thu</div>
              <div class="hour-type-day-cell">Fri</div>
              <div class="hour-type-day-cell">Sat</div>
              <div class="hour-type-total-cell">Total</div>
              <div class="hour-type-actions-cell">Actions</div>
            </div>
            <!-- Dynamic rows will be inserted here by JavaScript -->
            <div id="hour-type-rows"></div>
            <!-- Day Totals Footer Row (REQ-007) -->
            <div
              id="day-totals-row"
              class="hour-type-row day-totals-row hidden"
            >
              <div class="hour-type-label-cell">Total</div>
              <div class="hour-type-day-cell" data-day="0">0</div>
              <div class="hour-type-day-cell" data-day="1">0</div>
              <div class="hour-type-day-cell" data-day="2">0</div>
              <div class="hour-type-day-cell" data-day="3">0</div>
              <div class="hour-type-day-cell" data-day="4">0</div>
              <div class="hour-type-day-cell" data-day="5">0</div>
              <div class="hour-type-day-cell" data-day="6">0</div>
              <div class="hour-type-total-cell" id="grand-total">0</div>
              <div class="hour-type-actions-cell"></div>
            </div>
          </div>
        </div>

        <!-- Additional Info -->
        <div class="form-section">
          <div class="form-section-header">
            <div class="form-section-icon">üìù</div>
            <h3>Additional Information</h3>
          </div>
          <div class="checkbox-group">
            <div class="checkbox-item">
              <input type="checkbox" id="traveled" name="traveled" />
              <label for="traveled">Traveled this week</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="has-expenses" name="has_expenses" />
              <label for="has-expenses">Has expenses</label>
            </div>
            <div class="checkbox-item">
              <input
                type="checkbox"
                id="reimbursement-needed"
                name="reimbursement_needed"
              />
              <label for="reimbursement-needed">Reimbursement needed</label>
            </div>
        </div>

        <!-- Travel Details (shown when traveled checkbox checked) - REQ-024 -->
        <div id="travel-section" class="form-section hidden">
          <div class="form-section-header">
            <div class="form-section-icon">‚úàÔ∏è</div>
            <h3>Travel Details</h3>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="miles-traveled">Miles Traveled</label>
              <input
                type="number"
                id="miles-traveled"
                name="miles_traveled"
                class="form-input"
                step="1"
                min="0"
                max="9999"
                value="0"
                placeholder="0"
              />
              <small class="form-hint">Total round-trip miles for the week</small>
            </div>
            <div class="form-group">
              <label for="travel-method">Travel Method</label>
              <select
                id="travel-method"
                name="travel_method"
                class="form-select"
              >
                <option value="">Select method...</option>
                <option value="personal_car">üöó Personal Car</option>
                <option value="company_car">üöô Company Car</option>
                <option value="rental">üöê Rental Vehicle</option>
                <option value="flight">‚úàÔ∏è Flight</option>
                <option value="other">üì¶ Other</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="travel-from">Starting Location</label>
              <input
                type="text"
                id="travel-from"
                name="travel_from"
                class="form-input"
                maxlength="100"
                placeholder="City or address (optional)"
              />
            </div>
            <div class="form-group">
              <label for="travel-to">Destination</label>
              <input
                type="text"
                id="travel-to"
                name="travel_to"
                class="form-input"
                maxlength="100"
                placeholder="City or address (optional)"
              />
          </div>
          </div>
          <div class="mileage-estimate" id="mileage-estimate" style="display: none;">
            <span class="estimate-label">Estimated Mileage Reimbursement:</span>
            <span class="estimate-value" id="mileage-estimate-value">$0.00</span>
            <small class="estimate-hint">(at $0.67/mile IRS rate)</small>
          </div>
        </div>

        <!-- Expense Details (shown when has-expenses checkbox checked) - REQ-027 -->
        <div id="expense-section" class="form-section hidden">
          <div class="form-section-header">
            <div class="form-section-icon">üßæ</div>
            <h3>Expense Details</h3>
          </div>
          <div class="form-row">
            <div class="form-group" style="flex: 2;">
              <label for="expense-summary">Expense Summary</label>
              <textarea
                id="expense-summary"
                name="expense_summary"
                class="form-textarea"
                rows="3"
                maxlength="500"
                placeholder="Describe your expenses (e.g., client dinner, office supplies, conference registration...)"
              ></textarea>
              <small class="form-hint">Brief description of expenses incurred</small>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="expense-total">Estimated Total ($)</label>
              <input
                type="number"
                id="expense-total"
                name="expense_total"
                class="form-input"
                step="0.01"
                min="0"
                max="10000"
                value="0.00"
                placeholder="0.00"
              />
            </div>
            <div class="form-group">
              <label for="expense-paid-by">Paid By</label>
              <select
                id="expense-paid-by"
                name="expense_paid_by"
                class="form-select"
              >
                <option value="">Select who paid...</option>
                <option value="employee">üí≥ Employee (needs reimbursement)</option>
                <option value="company_card">üè¢ Company Card</option>
                <option value="client">üë§ Client Direct</option>
                <option value="prepaid">üì¶ Pre-paid/Approved</option>
              </select>
            </div>
          </div>
          <div class="expense-notice" id="expense-reimbursement-notice" style="display: none;">
            <span class="notice-icon">üí°</span>
            <span class="notice-text">If you paid out-of-pocket, check "Reimbursement needed" above and fill out the reimbursement details.</span>
          </div>
        </div>

        <!-- Reimbursement Details (shown when reimbursement-needed checked) - REQ-028 -->
        <div id="reimbursement-section" class="form-section hidden">
          <div class="form-section-header">
            <div class="form-section-icon">üí∞</div>
            <h3>Reimbursement Details</h3>
          </div>
          
          <!-- Reimbursement Line Items Container -->
          <div id="reimbursement-items" class="reimbursement-items">
            <!-- Dynamic line items will be added here by JavaScript -->
          </div>
          
          <!-- Add Item Button -->
          <div class="add-item-row">
            <button type="button" id="add-reimbursement-btn" class="btn btn-secondary btn-sm">
              ‚ûï Add Expense Item
            </button>
          </div>
          
          <!-- Running Total -->
          <div class="reimbursement-total">
            <span class="total-label">Total Reimbursement:</span>
            <span class="total-value" id="reimbursement-total-value">$0.00</span>
          </div>
          
          <!-- Hidden field for backward compatibility -->
          <input type="hidden" id="reimbursement-amount" name="reimbursement_amount" value="0" />
          <input type="hidden" id="reimbursement-type" name="reimbursement_type" value="" />
          <input type="hidden" id="stipend-date" name="stipend_date" value="" />
        </div>

        <!-- Attachments -->
        <div class="form-section">
          <div class="form-section-header">
            <div class="form-section-icon">üìé</div>
            <h3>Attachments</h3>
            <button
              type="button"
              class="help-icon"
              id="attachment-help-btn"
              title="Attachment Requirements"
            >
              ?
            </button>
            <!-- Attachment Info Popup -->
            <div id="attachment-help-popup" class="help-popup hidden">
              <div class="help-popup-header">
                <h4>Attachment Requirements</h4>
                <button
                  type="button"
                  class="help-popup-close"
                  id="attachment-help-close"
                >
                  &times;
                </button>
              </div>
              <div class="help-popup-content">
                <dl class="help-definitions">
                  <dt>Field Hours</dt>
                  <dd>
                    Field engineers must upload at least one image as proof of
                    work.
                  </dd>
                  <dt>Reimbursement Items</dt>
                  <dd>
                    Each reimbursement type requires its own receipt or supporting documentation.
                  </dd>
                  <dt>Car</dt>
                  <dd>Mileage log or receipt.</dd>
                  <dt>Flight</dt>
                  <dd>Flight receipt or confirmation.</dd>
                  <dt>Food</dt>
                  <dd>Meal receipts.</dd>
                  <dt>Other</dt>
                  <dd>Supporting documentation.</dd>
                  <dt>Accepted Formats</dt>
                  <dd>PDF, PNG, JPG, JPEG, GIF files are supported.</dd>
                  <dt>File Size Limit</dt>
                  <dd>Maximum 16MB per file.</dd>
                  <dt>Multiple Files</dt>
                  <dd>
                    You can attach multiple files by dragging or selecting them.
                  </dd>
                </dl>
              </div>
            </div>
          </div>
          <!-- Field Hours Warning -->
          <div id="field-hours-warning" class="field-hours-warning hidden">
            ‚ö†Ô∏è Field engineers must submit at least one image.
          </div>
          <!-- Reimbursement Attachment Warning -->
          <div id="reimbursement-attachments-warning" class="field-hours-warning hidden">
            ‚ö†Ô∏è Reimbursement items require attachments for:
            <span id="reimbursement-attachments-missing"></span>
          </div>
          <div class="attachment-meta">
            <label for="attachment-purpose" class="filter-label">Attach for:</label>
            <select id="attachment-purpose" class="form-select form-select-sm">
              <option value="">Field Hours / General</option>
            </select>
          </div>
          <div class="attachments-section">
            <div id="attachments-list" class="attachments-list">
              <p id="empty-attachments-text" class="empty-attachments-text">
                There is nothing attached.
              </p>
            </div>
            <div id="upload-zone" class="upload-zone">
              <div class="upload-zone-icon">üìÅ</div>
              <p>Drag & drop files here or <strong>browse</strong></p>
              <small>PDF, PNG, JPG, GIF up to 16MB</small>
              <input
                type="file"
                id="file-upload"
                accept=".pdf,.png,.jpg,.jpeg,.gif"
                multiple
                hidden
              />
            </div>
          </div>
        </div>

        <!-- User Notes -->
        <div class="form-section">
          <div class="form-section-header">
            <div class="form-section-icon">üí¨</div>
            <h3>Notes</h3>
          </div>
          <div class="form-group">
            <label for="user-notes"
              >Your Notes
              <span class="char-counter" id="user-notes-counter"
                >0/255</span
              ></label
            >
            <textarea
              id="user-notes"
              name="user_notes"
              class="form-textarea"
              rows="3"
              maxlength="255"
              placeholder="Enter any comments (255 characters max)..."
            ></textarea>
          </div>
        </div>

        <!-- Admin Notes (read-only for users) -->
        <div id="admin-notes-section" class="form-section">
          <div class="form-section-header">
            <div class="form-section-icon">üë§</div>
            <h3>Admin Notes</h3>
          </div>
          <div class="form-group">
            <div id="admin-notes-display" class="admin-notes-display"></div>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button
            type="button"
            id="delete-btn"
            class="btn btn-danger-outline hidden"
          >
            üóëÔ∏è Delete
          </button>
          <button type="button" id="save-draft-btn" class="btn btn-secondary">
            üíæ Save Draft
          </button>
          <button type="button" id="submit-btn" class="btn btn-primary">
            üöÄ Submit
          </button>
        </div>
      </form>
    </section>

    <!-- User Settings View (REQ-003) -->
    <section id="view-settings" class="view">
      <div class="view-header">
        <h2>User Settings</h2>
        <button class="btn btn-ghost" id="settings-back-btn">‚Üê Back</button>
      </div>

      <!-- Appearance Section -->
      <div class="settings-section" id="settings-appearance-section">
        <div class="settings-section-header">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
          <h3>Appearance</h3>
        </div>
        <div class="settings-grid">
          <!-- Dark Mode Card -->
          <div class="settings-card" id="settings-darkmode-section">
            <div class="settings-card-header">
              <div class="settings-card-title">
                <span class="settings-icon">üåô</span>
                <div>
                  <h3>Dark Mode</h3>
                  <p class="settings-card-subtitle">
                    Choose your preferred color scheme.
                  </p>
                </div>
              </div>
            </div>
            <div class="settings-card-body">
              <div class="settings-toggle-row">
                <div class="settings-toggle-info">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                  <span>Automatic (System Settings)</span>
                </div>
                <label class="toggle">
                  <input type="checkbox" id="settings-theme-auto" />
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="settings-toggle-row">
                <div class="settings-toggle-info">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                  <span>Dark Mode</span>
                </div>
                <label class="toggle">
                  <input type="checkbox" id="settings-theme-dark" checked />
                  <span class="toggle-slider"></span>
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Notifications Section -->
      <div class="settings-section" id="settings-notifications-section">
        <div class="settings-section-header">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
          <h3>Notifications</h3>
        </div>
        <div class="settings-grid">
          <div class="settings-card" id="settings-email-section">
            <div class="settings-card-header">
              <div class="settings-card-title">
                <span class="settings-icon">üìß</span>
                <div>
                  <h3>Email Notifications</h3>
                  <p class="settings-card-subtitle">
                    Add one or more email addresses for alerts.
                  </p>
                </div>
              </div>
              <label class="toggle">
                <input type="checkbox" id="settings-email-toggle" />
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="settings-card-body" id="settings-email-body">
              <div class="settings-list" id="settings-email-list"></div>
              <div class="settings-add">
                <input
                  type="email"
                  id="settings-email-input"
                  class="form-input"
                  placeholder="name@northstar.com"
                />
                <button
                  type="button"
                  class="btn btn-ghost btn-sm"
                  id="settings-email-add"
                >
                  Add
                </button>
              </div>
            </div>
          </div>

          <div class="settings-card" id="settings-sms-section">
            <div class="settings-card-header">
              <div class="settings-card-title">
                <span class="settings-icon">üì±</span>
                <div>
                  <h3>SMS Notifications</h3>
                  <p class="settings-card-subtitle">
                    Add phone numbers for SMS reminders.
                  </p>
                </div>
              </div>
              <label class="toggle">
                <input type="checkbox" id="settings-sms-toggle" />
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="settings-card-body" id="settings-sms-body">
              <div class="settings-list" id="settings-phone-list"></div>
              <div class="settings-add">
                <input
                  type="tel"
                  id="settings-phone-input"
                  class="form-input"
                  placeholder="+1 (555) 123-4567"
                />
                <button
                  type="button"
                  class="btn btn-ghost btn-sm"
                  id="settings-phone-add"
                >
                  Add
                </button>
              </div>
            </div>
          </div>

          <div class="settings-card" id="settings-teams-section">
            <div class="settings-card-header">
              <div class="settings-card-title">
                <span class="settings-icon">üí¨</span>
                <div>
                  <h3>Teams Notifications</h3>
                  <p class="settings-card-subtitle">
                    Connect a Microsoft account for Teams alerts.
                  </p>
                </div>
              </div>
              <label class="toggle">
                <input type="checkbox" id="settings-teams-toggle" />
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="settings-card-body" id="settings-teams-body">
              <div class="settings-add">
                <input
                  type="email"
                  id="settings-teams-account"
                  class="form-input"
                  placeholder="teams@northstar.com"
                />
                <div class="settings-hint">Save to connect Teams.</div>
              </div>
              <div class="settings-status" id="settings-teams-status"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="settings-actions">
        <button type="button" class="btn btn-primary" id="settings-save-btn">
          Save Settings
        </button>
      </div>
    </section>

    <!-- Admin Dashboard View (REQ-041: Also visible for Support role) -->
    {% if user.is_admin or user.role == 'support' %}
    <!-- prettier-ignore -->
    <section id="view-admin" class="view" data-view-mode="{% if user.role == 'support' %}trainee_approvals{% else %}admin{% endif %}">
      <div class="view-header">
        <h2>{% if user.role == 'support' %}Trainee Approvals{% else %}Admin Dashboard{% endif %}</h2>
      </div>

      <div class="stats-grid">
        <div
          class="stat-card clickable"
          data-filter="SUBMITTED"
          id="stat-card-pending"
          title="Click to filter"
        >
          <div class="stat-icon primary">üìä</div>
          <div class="stat-content">
            <h4 id="stat-pending">-</h4>
            <p>Pending Review</p>
          </div>
        </div>
        <div
          class="stat-card clickable"
          data-filter="APPROVED"
          id="stat-card-approved"
          title="Click to filter"
        >
          <div class="stat-icon accent">‚úÖ</div>
          <div class="stat-content">
            <h4 id="stat-approved">-</h4>
            <p>Approved This Week</p>
          </div>
        </div>
        <div
          class="stat-card clickable"
          data-filter="NEEDS_APPROVAL"
          id="stat-card-attention"
          title="Click to filter"
        >
          <div class="stat-icon warning">‚ö†Ô∏è</div>
          <div class="stat-content">
            <h4 id="stat-needs-attention">-</h4>
            <p>Needs Attention</p>
          </div>
        </div>
      </div>

      <div class="admin-section">
        <div class="filters">
          <div class="filter-group">
            <label class="filter-label">Status:</label>
            <select id="admin-filter-status" class="form-select">
              <option value="" selected>All Statuses</option>
              <option value="SUBMITTED">Submitted</option>
              <option value="NEEDS_APPROVAL">Needs Approval</option>
              <option value="APPROVED">Approved</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">User:</label>
            <select id="admin-filter-user" class="form-select">
              <option value="">All Users</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">Hours:</label>
            <select id="admin-filter-hourtype" class="form-select">
              <option value="">All Types</option>
              <option value="Field">Field Hours</option>
              <option value="Internal">Internal Hours</option>
              <option value="Training">Training</option>
              <option value="PTO">PTO</option>
              <option value="Holiday">Holiday</option>
              <option value="has_field">Has Field Hours</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">Week:</label>
            <input
              type="date"
              id="admin-filter-week"
              class="form-input"
              placeholder="Filter by week"
            />
            <button
              class="btn btn-ghost btn-sm"
              id="admin-this-week-btn"
              title="Filter to current week"
            >
              üìÖ This Week
            </button>
            <button
              class="btn btn-ghost btn-sm"
              id="admin-pay-period-btn"
              title="Filter to current pay period (biweekly)"
            >
              üíµ Pay Period
            </button>
            <span id="pay-period-display" class="pay-period-display" style="display: none;"></span>
            {% if user.is_admin %}
            <button
              class="btn btn-ghost btn-sm"
              id="admin-confirm-pay-period-btn"
              title="Confirm and lock this pay period"
              disabled
            >
              ‚úÖ Confirm Pay Period
            </button>
            <span id="pay-period-confirmed" class="pay-period-confirmed hidden">Confirmed</span>
            {% endif %}
          </div>
          <div class="filter-group">
            <select id="admin-export-format" class="form-select form-select-sm" title="Export format">
              <option value="csv">CSV</option>
              <option value="xlsx">Excel (.xlsx)</option>
              <option value="pdf">PDF</option>
            </select>
            <button
              class="btn btn-ghost btn-sm"
              id="admin-clear-filters"
              title="Clear all filters"
            >
              üîÑ Reset
            </button>
            <button
              class="btn btn-ghost btn-sm"
              id="admin-export-btn"
              title="Export to CSV"
            >
              üìä Export
            </button>
            {% if user.is_admin %}
            <button
              class="btn btn-ghost btn-sm hidden"
              id="admin-export-pay-period-btn"
              title="Export confirmed pay period"
            >
              üì§ Export Payroll
            </button>
            {% endif %}
          </div>
        </div>

        <div id="admin-timesheets-list" class="timesheets-grid">
          <div class="loading">Loading timesheets...</div>
        </div>
      </div>

      <div id="admin-detail" class="timesheet-detail hidden">
        <!-- Populated by JavaScript -->
      </div>
    </section>
    {% endif %}

    {% if user.is_admin %}
    <section id="view-report" class="view">
      <div class="view-header">
        <h2>Timesheet Data Report</h2>
        <div class="view-header-actions">
          <button class="btn btn-ghost" id="report-refresh-btn" title="Refresh report">
            <span>üîÑ</span>
            Refresh
          </button>
        </div>
      </div>

      <div class="admin-section">
        <div class="filters">
          <div class="filter-group">
            <label class="filter-label">User:</label>
            <select id="report-filter-user" class="form-select">
              <option value="">All Users</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">Status:</label>
            <select id="report-filter-status" class="form-select">
              <option value="">All Statuses</option>
              <option value="SUBMITTED">Submitted</option>
              <option value="NEEDS_APPROVAL">Needs Approval</option>
              <option value="APPROVED">Approved</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">Hour Type:</label>
            <select id="report-filter-hourtype" class="form-select">
              <option value="">All Types</option>
              <option value="Field">Field Hours</option>
              <option value="Internal">Internal Hours</option>
              <option value="Training">Training</option>
              <option value="PTO">PTO</option>
              <option value="Holiday">Holiday</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">Week:</label>
            <input type="date" id="report-filter-week" class="form-input" />
          </div>
          <div class="filter-group">
            <label class="filter-label">Entry Dates:</label>
            <div class="date-range">
              <input type="date" id="report-filter-start" class="form-input" />
              <span class="date-range-sep">‚Üí</span>
              <input type="date" id="report-filter-end" class="form-input" />
            </div>
          </div>
          <div class="filter-group">
            <label class="filter-label">Rows:</label>
            <select id="report-per-page" class="form-select form-select-sm">
              <option value="100">100</option>
              <option value="200" selected>200</option>
              <option value="500">500</option>
            </select>
          </div>
          <div class="filter-group">
            <button class="btn btn-ghost btn-sm" id="report-clear-filters">üîÑ Reset</button>
          </div>
        </div>

        <div class="report-meta" id="report-meta">Loading report...</div>

        <div class="report-table-wrapper">
          <table class="report-table">
            <thead>
              <tr>
                <th>Employee</th>
                <th>Email</th>
                <th>Week Start</th>
                <th>Entry Date</th>
                <th>Hour Type</th>
                <th>Hours</th>
                <th>Status</th>
                <th>Total</th>
                <th>Payable</th>
                <th>Billable</th>
                <th>Unpaid</th>
                <th>Travel</th>
                <th>Expenses</th>
                <th>Reimbursement</th>
                <th>Attachments</th>
                <th>Open</th>
              </tr>
            </thead>
            <tbody id="report-table-body">
              <tr>
                <td colspan="16">Loading report...</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="report-pagination">
          <button class="btn btn-ghost btn-sm" id="report-prev">‚óÄ Prev</button>
          <span id="report-page-label">Page 1</span>
          <button class="btn btn-ghost btn-sm" id="report-next">Next ‚ñ∂</button>
        </div>
      </div>
    </section>
    {% endif %}
  </main>
</div>

<!-- Toast Container -->
<div id="toast-container" class="toast-container"></div>
{% endblock %} {% block extra_js %}
<script>
  window.currentUser = {{ user|tojson }};
</script>
<script src="{{ url_for('static', filename='js/api.js') }}?v=20260108p1"></script>
<!-- REQ-044: New modular timesheet scripts -->
<script src="{{ url_for('static', filename='js/timesheet/state.js') }}?v=20260109"></script>
<script src="{{ url_for('static', filename='js/timesheet/dates.js') }}?v=20260109"></script>
<script src="{{ url_for('static', filename='js/timesheet/entries.js') }}?v=20260109"></script>
<script src="{{ url_for('static', filename='js/timesheet/attachments.js') }}?v=20260109"></script>
<script src="{{ url_for('static', filename='js/timesheet/index.js') }}?v=20260109"></script>
<!-- Legacy timesheet.js - will be deprecated incrementally -->
<script src="{{ url_for('static', filename='js/timesheet.js') }}?v=20260111p1"></script>
<script src="{{ url_for('static', filename='js/admin.js') }}?v=20260108p6"></script>
<script src="{{ url_for('static', filename='js/settings.js') }}?v=20260110p1"></script>
<script src="{{ url_for('static', filename='js/sse.js') }}?v=20260106p1"></script>
<script src="{{ url_for('static', filename='js/app.js') }}?v=20260111p1"></script>
{% endblock %}
