{% extends "base.html" %}

{% block title %}Northstar Time Timesheet - Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}?v=2" />
{% endblock %}

{% block content %}
<div class="app-container">
  <!-- Sidebar Navigation -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <p class="sidebar-title">Navigation</p>
    </div>
    
    <nav class="sidebar-nav">
      <a href="#timesheets" class="sidebar-link active" data-view="timesheets">
        <span class="icon">ğŸ“‹</span>
        My Timesheets
      </a>
      <a href="#new" class="sidebar-link" data-view="editor">
        <span class="icon">âœ¨</span>
        New Timesheet
      </a>
      {% if user.is_admin %}
      <hr class="sidebar-divider" />
      <a href="#admin" class="sidebar-link" data-view="admin">
        <span class="icon">ğŸ‘¥</span>
        Admin Dashboard
      </a>
      {% endif %}
    </nav>
  </aside>

  <!-- Main Content Area -->
  <main class="content-area">
    
    <!-- Timesheets List View -->
    <section id="view-timesheets" class="view active">
      <div class="view-header">
        <h2>My Timesheets</h2>
        <div class="view-header-actions">
          <button class="btn btn-primary" id="create-timesheet-btn">
            <span>âœ¨</span>
            New Timesheet
          </button>
        </div>
      </div>
      
      <div class="filters">
        <div class="filter-group">
          <label class="filter-label">Status:</label>
          <select id="filter-status" class="form-select">
            <option value="">All Statuses</option>
            <option value="NEW">Draft</option>
            <option value="SUBMITTED">Submitted</option>
            <option value="NEEDS_APPROVAL">Needs Approval</option>
            <option value="APPROVED">Approved</option>
          </select>
        </div>
      </div>
      
      <div id="timesheets-list" class="timesheets-grid">
        <div class="loading">Loading timesheets...</div>
      </div>
    </section>

    <!-- Timesheet Editor View -->
    <section id="view-editor" class="view">
      <div class="view-header">
        <h2 id="editor-title">New Timesheet</h2>
        <button class="btn btn-ghost" id="back-to-list-btn">
          â† Back to List
        </button>
      </div>
      
      <form id="timesheet-form" class="timesheet-form">
        <input type="hidden" id="timesheet-id" />
        
        <!-- Week Selection -->
        <div class="form-section">
          <div class="form-section-header">
            <div class="form-section-icon">ğŸ“…</div>
            <h3>Week Selection</h3>
          </div>
          <div class="form-group">
            <label for="week-start">Week Starting (Sunday)</label>
            <input type="date" id="week-start" name="week_start" class="form-input" required />
          </div>
        </div>

        <!-- Time Entries -->
        <div class="form-section">
          <div class="form-section-header">
            <div class="form-section-icon">â±ï¸</div>
            <h3>Time Entries</h3>
          </div>
          
          <!-- Add Hour Type Row -->
          <div class="add-hour-type-row">
            <select id="hour-type-selector" class="form-select">
              <option value="">Select hour type to add...</option>
              <option value="Field">Field Hours</option>
              <option value="Internal">Internal Hours</option>
              <option value="Training">Training</option>
              <option value="PTO">PTO</option>
              <option value="Unpaid">Unpaid Leave</option>
              <option value="Holiday">Holiday</option>
            </select>
            <button type="button" id="add-hour-type-btn" class="btn btn-icon" title="Add hour type">
              +
            </button>
          </div>

          <!-- Hour Type Rows Table -->
          <div id="hour-type-table" class="hour-type-table">
            <!-- Table Header -->
            <div class="hour-type-header">
              <div class="hour-type-label-cell">Hour Type</div>
              <div class="hour-type-day-cell">Sun</div>
              <div class="hour-type-day-cell">Mon</div>
              <div class="hour-type-day-cell">Tue</div>
              <div class="hour-type-day-cell">Wed</div>
              <div class="hour-type-day-cell">Thu</div>
              <div class="hour-type-day-cell">Fri</div>
              <div class="hour-type-day-cell">Sat</div>
              <div class="hour-type-actions-cell">Actions</div>
            </div>
            <!-- Dynamic rows will be inserted here by JavaScript -->
            <div id="hour-type-rows"></div>
          </div>
        </div>

        <!-- Additional Info -->
        <div class="form-section">
          <div class="form-section-header">
            <div class="form-section-icon">ğŸ“</div>
            <h3>Additional Information</h3>
          </div>
          <div class="checkbox-group">
            <div class="checkbox-item">
              <input type="checkbox" id="traveled" name="traveled" />
              <label for="traveled">Traveled this week</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="has-expenses" name="has_expenses" />
              <label for="has-expenses">Has expenses</label>
            </div>
            <div class="checkbox-item">
              <input
                type="checkbox"
                id="reimbursement-needed"
                name="reimbursement_needed"
              />
              <label for="reimbursement-needed">Reimbursement needed</label>
            </div>
          </div>
        </div>

        <!-- Reimbursement Details (shown when reimbursement-needed checked) -->
        <div id="reimbursement-section" class="form-section hidden">
          <div class="form-section-header">
            <div class="form-section-icon">ğŸ’°</div>
            <h3>Reimbursement Details</h3>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="reimbursement-type">Type</label>
              <select id="reimbursement-type" name="reimbursement_type" class="form-select">
                <option value="">Select type...</option>
                <option value="Car">Car</option>
                <option value="Flight">Flight</option>
                <option value="Food">Food</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="form-group">
              <label for="reimbursement-amount">Amount ($)</label>
              <input type="number" id="reimbursement-amount" name="reimbursement_amount" class="form-input" step="0.01" min="0" placeholder="0.00" />
            </div>
            <div class="form-group">
              <label for="stipend-date">Stipend Date</label>
              <input type="date" id="stipend-date" name="stipend_date" class="form-input" />
            </div>
          </div>
        </div>

        <!-- Attachments -->
        <div class="form-section">
          <div class="form-section-header">
            <div class="form-section-icon">ğŸ“</div>
            <h3>Attachments</h3>
          </div>
          <div class="attachments-section">
            <div id="attachments-list" class="attachments-list"></div>
            <div id="upload-zone" class="upload-zone">
              <div class="upload-zone-icon">ğŸ“</div>
              <p>Drag & drop files here or <strong>browse</strong></p>
              <small>PDF, PNG, JPG, GIF up to 16MB</small>
              <input type="file" id="file-upload" accept=".pdf,.png,.jpg,.jpeg,.gif" multiple hidden />
            </div>
          </div>
        </div>

        <!-- Notes -->
        <div class="form-section">
          <div class="form-section-header">
            <div class="form-section-icon">ğŸ’¬</div>
            <h3>Notes</h3>
          </div>
          <div id="notes-list" class="notes-list"></div>
          <div class="form-group">
            <label for="new-note">Add a note</label>
            <textarea id="new-note" name="new_note" class="form-textarea" rows="3" placeholder="Enter any comments or notes..."></textarea>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button type="button" id="delete-btn" class="btn btn-danger hidden">
            ğŸ—‘ï¸ Delete
          </button>
          <button type="button" id="save-draft-btn" class="btn btn-secondary">
            ğŸ’¾ Save Draft
          </button>
          <button type="button" id="submit-btn" class="btn btn-primary">
            ğŸš€ Submit
          </button>
        </div>
      </form>
    </section>

    <!-- Admin Dashboard View -->
    {% if user.is_admin %}
    <section id="view-admin" class="view">
      <div class="view-header">
        <h2>Admin Dashboard</h2>
      </div>
      
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon primary">ğŸ“Š</div>
          <div class="stat-content">
            <h4 id="stat-pending">-</h4>
            <p>Pending Review</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon accent">âœ…</div>
          <div class="stat-content">
            <h4 id="stat-approved">-</h4>
            <p>Approved This Week</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon warning">âš ï¸</div>
          <div class="stat-content">
            <h4 id="stat-needs-attention">-</h4>
            <p>Needs Attention</p>
          </div>
        </div>
      </div>
      
      <div class="admin-section">
        <div class="filters">
          <div class="filter-group">
            <label class="filter-label">Status:</label>
            <select id="admin-filter-status" class="form-select">
              <option value="">All Statuses</option>
              <option value="SUBMITTED" selected>Submitted</option>
              <option value="NEEDS_APPROVAL">Needs Approval</option>
              <option value="APPROVED">Approved</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">User:</label>
            <select id="admin-filter-user" class="form-select">
              <option value="">All Users</option>
            </select>
          </div>
        </div>
        
        <div id="admin-timesheets-list" class="timesheets-grid">
          <div class="loading">Loading timesheets...</div>
        </div>
      </div>
      
      <div id="admin-detail" class="timesheet-detail hidden">
        <!-- Populated by JavaScript -->
      </div>
    </section>
    {% endif %}
    
  </main>
</div>

<!-- Toast Container -->
<div id="toast-container" class="toast-container"></div>
{% endblock %}

{% block extra_js %}
<script>
  window.currentUser = {{ user|tojson }};
</script>
<script src="{{ url_for('static', filename='js/api.js') }}?v=2"></script>
<script src="{{ url_for('static', filename='js/timesheet.js') }}?v=2"></script>
<script src="{{ url_for('static', filename='js/admin.js') }}?v=2"></script>
<script src="{{ url_for('static', filename='js/sse.js') }}?v=2"></script>
<script src="{{ url_for('static', filename='js/app.js') }}?v=2"></script>
{% endblock %}
