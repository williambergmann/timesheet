# Render.com Infrastructure as Code
# Deploy: Connect GitHub repo in Render Dashboard, it will auto-detect this file
# Docs: https://render.com/docs/blueprint-spec

services:
  # Flask Web Service
  - type: web
    name: northstar-timesheet
    runtime: python
    region: oregon  # Free tier available
    plan: free
    buildCommand: pip install -r requirements.txt
    startCommand: flask db upgrade && gunicorn --bind 0.0.0.0:$PORT --worker-class gevent --workers 2 --timeout 120 "app:create_app()"
    envVars:
      # Database (auto-linked from database below)
      - key: DATABASE_URL
        fromDatabase:
          name: northstar-timesheet-db
          property: connectionString
      # Flask configuration
      - key: FLASK_APP
        value: app
      - key: FLASK_ENV
        value: production
      # Security: Generate a strong secret key
      - key: SECRET_KEY
        generateValue: true
      # Python configuration for Render
      - key: PYTHON_VERSION
        value: "3.11.7"
      # Disable Redis for free tier (uses in-memory fallback)
      - key: REDIS_URL
        value: ""
      # Rate limiting storage (memory for free tier)
      - key: RATELIMIT_STORAGE_URL
        value: "memory://"
      # File uploads (Render has ephemeral storage, uploads will be lost on redeploy)
      - key: UPLOAD_FOLDER
        value: /tmp/uploads
      # Sentry (optional - leave empty to disable)
      - key: SENTRY_DSN
        value: ""
      - key: SENTRY_ENVIRONMENT
        value: render-production
    # Health check endpoint
    healthCheckPath: /health
    # Auto-deploy on push to main branch
    autoDeploy: true

databases:
  # PostgreSQL Database (Free tier: 90 days, then $7/mo)
  - name: northstar-timesheet-db
    plan: free
    region: oregon
    databaseName: timesheet
    user: timesheet
